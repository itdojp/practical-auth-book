<?xml version="1.0" encoding="UTF-8"?>
<svg width="800" height="600" viewBox="0 0 800 600" xmlns="http://www.w3.org/2000/svg">
  <title>JWTトークンライフサイクル管理</title>
  <desc>JWTトークンの作成、検証、リフレッシュ、有効期限管理の完全なライフサイクルタイムライン</desc>
  <defs>
    <style>
      :root {
        --svg-bg: #ffffff;
        --svg-text: #1a1a1a;
        --svg-primary: #0066cc;
        --svg-success: #16a34a;
        --svg-warning: #ca8a04;
        --svg-error: #dc2626;
        --svg-neutral: #6b7280;
      }
      .title-text { font-family: Inter, 'Helvetica Neue', Arial, sans-serif; font-size: 16px; font-weight: 600; fill: var(--svg-text); }
      .phase-title { font-family: Inter, 'Helvetica Neue', Arial, sans-serif; font-size: 12px; font-weight: 500; fill: var(--svg-bg); }
      .component-text { font-family: Inter, 'Helvetica Neue', Arial, sans-serif; font-size: 12px; font-weight: 400; fill: var(--svg-text); }
      .annotation-text { font-family: Inter, 'Helvetica Neue', Arial, sans-serif; font-size: 10px; font-weight: 400; fill: var(--svg-neutral); }
      .code-text { font-family: 'Courier New', monospace; font-size: 9px; fill: var(--svg-text); }
      .creation-phase { fill: var(--svg-success); stroke: var(--svg-success); stroke-width: 2; }
      .validation-phase { fill: var(--svg-primary); stroke: var(--svg-primary); stroke-width: 2; }
      .refresh-phase { fill: var(--svg-warning); stroke: var(--svg-warning); stroke-width: 2; }
      .expiry-phase { fill: var(--svg-error); stroke: var(--svg-error); stroke-width: 2; }
      .timeline-line { stroke: var(--svg-neutral); stroke-width: 3; fill: none; }
      .phase-flow { stroke: var(--svg-primary); stroke-width: 2; fill: none; marker-end: url(#arrowhead); }
    </style>
    <marker id="arrowhead" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
      <polygon points="0 0, 10 3, 0 6" fill="var(--svg-primary)"/>
    </marker>
  </defs>

  <!-- Title -->
  <text x="400" y="30" class="title-text" text-anchor="middle">JWTトークンライフサイクル管理</text>

  <!-- Timeline -->
  <g id="timeline">
    <line x1="100" y1="80" x2="700" y2="80" class="timeline-line"/>
    
    <!-- Time Markers -->
    <g id="time-markers">
      <line x1="120" y1="70" x2="120" y2="90" stroke="var(--svg-neutral)" stroke-width="2"/>
      <text x="120" y="105" class="annotation-text" text-anchor="middle">T0</text>
      <text x="120" y="115" class="annotation-text" text-anchor="middle">開始</text>
      
      <line x1="250" y1="70" x2="250" y2="90" stroke="var(--svg-neutral)" stroke-width="2"/>
      <text x="250" y="105" class="annotation-text" text-anchor="middle">T+15m</text>
      <text x="250" y="115" class="annotation-text" text-anchor="middle">使用中</text>
      
      <line x1="400" y1="70" x2="400" y2="90" stroke="var(--svg-neutral)" stroke-width="2"/>
      <text x="400" y="105" class="annotation-text" text-anchor="middle">T+30m</text>
      <text x="400" y="115" class="annotation-text" text-anchor="middle">期限間近</text>
      
      <line x1="550" y1="70" x2="550" y2="90" stroke="var(--svg-neutral)" stroke-width="2"/>
      <text x="550" y="105" class="annotation-text" text-anchor="middle">T+60m</text>
      <text x="550" y="115" class="annotation-text" text-anchor="middle">期限切れ</text>
      
      <line x1="680" y1="70" x2="680" y2="90" stroke="var(--svg-neutral)" stroke-width="2"/>
      <text x="680" y="105" class="annotation-text" text-anchor="middle">T+7d</text>
      <text x="680" y="115" class="annotation-text" text-anchor="middle">完全失効</text>
    </g>
  </g>

  <!-- Phase 1: Token Creation -->
  <g id="creation-phase">
    <rect x="80" y="140" width="180" height="100" class="creation-phase" rx="4"/>
    <text x="170" y="160" class="phase-title" text-anchor="middle">1. トークン作成</text>
    
    <!-- JWT Structure -->
    <rect x="100" y="170" width="140" height="60" fill="var(--svg-bg)" stroke="var(--svg-success)" stroke-width="1" rx="4"/>
    <text x="170" y="185" class="component-text" text-anchor="middle" font-weight="500">JWT構造</text>
    <text x="110" y="200" class="code-text">Header.Payload.Signature</text>
    <text x="110" y="210" class="annotation-text">• alg: "RS256"</text>
    <text x="110" y="220" class="annotation-text">• exp: 1640995200</text>
  </g>

  <!-- Phase 2: Token Validation -->
  <g id="validation-phase">
    <rect x="280" y="140" width="180" height="100" class="validation-phase" rx="4"/>
    <text x="370" y="160" class="phase-title" text-anchor="middle">2. トークン検証</text>
    
    <!-- Validation Steps -->
    <rect x="300" y="170" width="140" height="60" fill="var(--svg-bg)" stroke="var(--svg-primary)" stroke-width="1" rx="4"/>
    <text x="370" y="185" class="component-text" text-anchor="middle" font-weight="500">検証ステップ</text>
    <text x="310" y="200" class="annotation-text">• 署名検証</text>
    <text x="310" y="210" class="annotation-text">• 有効期限チェック</text>
    <text x="310" y="220" class="annotation-text">• issuer/audience検証</text>
  </g>

  <!-- Phase 3: Token Refresh -->
  <g id="refresh-phase">
    <rect x="480" y="140" width="180" height="100" class="refresh-phase" rx="4"/>
    <text x="570" y="160" class="phase-title" text-anchor="middle">3. トークンリフレッシュ</text>
    
    <!-- Refresh Process -->
    <rect x="500" y="170" width="140" height="60" fill="var(--svg-bg)" stroke="var(--svg-warning)" stroke-width="1" rx="4"/>
    <text x="570" y="185" class="component-text" text-anchor="middle" font-weight="500">リフレッシュ処理</text>
    <text x="510" y="200" class="annotation-text">• refresh_token使用</text>
    <text x="510" y="210" class="annotation-text">• 新しいaccess_token</text>
    <text x="510" y="220" class="annotation-text">• 古いトークン無効化</text>
  </g>

  <!-- Token States -->
  <g id="token-states">
    <rect x="100" y="260" width="600" height="120" fill="var(--svg-neutral)" fill-opacity="0.05" stroke="var(--svg-text)" stroke-width="2" rx="4"/>
    <text x="400" y="280" class="component-text" text-anchor="middle" font-weight="500">トークン状態遷移</text>
    
    <!-- Active State -->
    <rect x="120" y="300" width="120" height="60" fill="var(--svg-success)" fill-opacity="0.1" stroke="var(--svg-success)" stroke-width="2" rx="4"/>
    <text x="180" y="320" class="component-text" text-anchor="middle" font-weight="500">有効状態</text>
    <text x="130" y="335" class="annotation-text">• 署名有効</text>
    <text x="130" y="350" class="annotation-text">• 期限内 (exp > now)</text>
    
    <!-- Near Expiry -->
    <rect x="260" y="300" width="120" height="60" fill="var(--svg-warning)" fill-opacity="0.1" stroke="var(--svg-warning)" stroke-width="2" rx="4"/>
    <text x="320" y="320" class="component-text" text-anchor="middle" font-weight="500">期限間近</text>
    <text x="270" y="335" class="annotation-text">• 5分以内に期限切れ</text>
    <text x="270" y="350" class="annotation-text">• リフレッシュ推奨</text>
    
    <!-- Expired -->
    <rect x="400" y="300" width="120" height="60" fill="var(--svg-error)" fill-opacity="0.1" stroke="var(--svg-error)" stroke-width="2" rx="4"/>
    <text x="460" y="320" class="component-text" text-anchor="middle" font-weight="500">期限切れ</text>
    <text x="410" y="335" class="annotation-text">• exp < now</text>
    <text x="410" y="350" class="annotation-text">• 401 Unauthorized</text>
    
    <!-- Revoked -->
    <rect x="540" y="300" width="120" height="60" fill="var(--svg-neutral)" fill-opacity="0.1" stroke="var(--svg-neutral)" stroke-width="2" rx="4"/>
    <text x="600" y="320" class="component-text" text-anchor="middle" font-weight="500">失効済み</text>
    <text x="550" y="335" class="annotation-text">• ブラックリスト登録</text>
    <text x="550" y="350" class="annotation-text">• 手動失効</text>
  </g>

  <!-- Flow Arrows -->
  <path d="M 240 320 L 260 320" class="phase-flow"/>
  <path d="M 380 320 L 400 320" class="phase-flow"/>
  <path d="M 520 320 L 540 320" class="phase-flow"/>

  <!-- Detailed JWT Claims -->
  <g id="jwt-claims">
    <rect x="120" y="400" width="560" height="120" fill="var(--svg-primary)" fill-opacity="0.05" stroke="var(--svg-primary)" stroke-width="2" rx="4"/>
    <text x="400" y="420" class="component-text" text-anchor="middle" font-weight="500">JWT標準クレーム詳細</text>
    
    <!-- Standard Claims -->
    <text x="140" y="440" class="annotation-text" font-weight="500">標準クレーム:</text>
    <text x="140" y="455" class="code-text">iss: "https://auth.example.com" (発行者)</text>
    <text x="140" y="470" class="code-text">sub: "user123" (主体)</text>
    <text x="140" y="485" class="code-text">aud: "api.example.com" (対象者)</text>
    <text x="140" y="500" class="code-text">exp: 1640995200 (有効期限)</text>
    
    <!-- Custom Claims -->
    <text x="420" y="440" class="annotation-text" font-weight="500">カスタムクレーム:</text>
    <text x="420" y="455" class="code-text">roles: ["admin", "user"]</text>
    <text x="420" y="470" class="code-text">permissions: ["read", "write"]</text>
    <text x="420" y="485" class="code-text">tenant_id: "org_456"</text>
    <text x="420" y="500" class="code-text">session_id: "sess_789"</text>
  </g>

  <!-- Best Practices -->
  <g id="best-practices">
    <rect x="140" y="540" width="520" height="40" fill="var(--svg-success)" fill-opacity="0.1" stroke="var(--svg-success)" stroke-width="2" rx="4"/>
    <text x="400" y="560" class="component-text" text-anchor="middle" font-weight="500">ベストプラクティス</text>
    <text x="160" y="575" class="annotation-text">短期間有効期限 (15〜30分) • セキュアなリフレッシュトークン • 適切なクレーム設計 • トークンローテーション</text>
  </g>
</svg>