<?xml version="1.0" encoding="UTF-8"?>
<svg width="900" height="700" viewBox="0 0 900 700" xmlns="http://www.w3.org/2000/svg">
  <defs>
    <style>
      .title-text { font-family: 'Noto Sans JP', sans-serif; font-size: 18px; font-weight: bold; fill: #2c3e50; }
      .participant-box { fill: #fff; stroke: #34495e; stroke-width: 2; }
      .participant-text { font-family: 'Noto Sans JP', sans-serif; font-size: 12px; fill: #2c3e50; font-weight: bold; }
      .message-text { font-family: 'Noto Sans JP', sans-serif; font-size: 11px; fill: #34495e; }
      .note-text { font-family: 'Noto Sans JP', sans-serif; font-size: 10px; fill: #7f8c8d; font-style: italic; }
      .lifeline { stroke: #95a5a6; stroke-width: 1; stroke-dasharray: 3,3; }
      .message-arrow { stroke: #3498db; stroke-width: 2; fill: none; marker-end: url(#arrowhead); }
      .return-arrow { stroke: #27ae60; stroke-width: 2; fill: none; stroke-dasharray: 5,3; marker-end: url(#arrowhead-green); }
      .note-box { fill: #fffacd; stroke: #f39c12; stroke-width: 1; }
    </style>
    <marker id="arrowhead" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
      <polygon points="0 0, 10 3, 0 6" fill="#3498db"/>
    </marker>
    <marker id="arrowhead-green" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
      <polygon points="0 0, 10 3, 0 6" fill="#27ae60"/>
    </marker>
  </defs>

  <!-- Title -->
  <text x="450" y="30" class="title-text" text-anchor="middle">OAuth 2.0 認可コードフロー</text>

  <!-- Participants -->
  <g id="participants">
    <rect x="50" y="60" width="80" height="40" class="participant-box" rx="5"/>
    <text x="90" y="85" class="participant-text" text-anchor="middle">User</text>
    
    <rect x="200" y="60" width="80" height="40" class="participant-box" rx="5"/>
    <text x="240" y="85" class="participant-text" text-anchor="middle">Browser</text>
    
    <rect x="350" y="60" width="100" height="40" class="participant-box" rx="5"/>
    <text x="400" y="85" class="participant-text" text-anchor="middle">Client App</text>
    
    <rect x="520" y="60" width="120" height="40" class="participant-box" rx="5"/>
    <text x="580" y="85" class="participant-text" text-anchor="middle">Auth Server</text>
    
    <rect x="710" y="60" width="120" height="40" class="participant-box" rx="5"/>
    <text x="770" y="85" class="participant-text" text-anchor="middle">Resource Server</text>
  </g>

  <!-- Lifelines -->
  <line x1="90" y1="100" x2="90" y2="650" class="lifeline"/>
  <line x1="240" y1="100" x2="240" y2="650" class="lifeline"/>
  <line x1="400" y1="100" x2="400" y2="650" class="lifeline"/>
  <line x1="580" y1="100" x2="580" y2="650" class="lifeline"/>
  <line x1="770" y1="100" x2="770" y2="650" class="lifeline"/>

  <!-- Messages -->
  <g id="messages">
    <!-- 1. Access Application -->
    <path d="M 90 130 L 240 130" class="message-arrow"/>
    <text x="165" y="125" class="message-text" text-anchor="middle">アプリケーションアクセス</text>
    
    <!-- 2. Request Protected Resource -->
    <path d="M 240 160 L 400 160" class="message-arrow"/>
    <text x="320" y="155" class="message-text" text-anchor="middle">保護リソース要求</text>
    
    <!-- 3. Redirect to Auth Server -->
    <path d="M 400 190 L 240 190" class="return-arrow"/>
    <text x="320" y="185" class="message-text" text-anchor="middle">認証サーバーへリダイレクト</text>
    
    <!-- 4. Authorization Request -->
    <path d="M 240 220 L 580 220" class="message-arrow"/>
    <text x="410" y="215" class="message-text" text-anchor="middle">認可リクエスト</text>
    
    <!-- 5. Login Page -->
    <path d="M 580 250 L 90 250" class="return-arrow"/>
    <text x="335" y="245" class="message-text" text-anchor="middle">ログインページ表示</text>
    
    <!-- 6. Credentials -->
    <path d="M 90 280 L 580 280" class="message-arrow"/>
    <text x="335" y="275" class="message-text" text-anchor="middle">認証情報送信</text>
    
    <!-- 7. Consent Screen -->
    <path d="M 580 310 L 90 310" class="return-arrow"/>
    <text x="335" y="305" class="message-text" text-anchor="middle">同意画面表示</text>
    
    <!-- 8. Grant Permission -->
    <path d="M 90 340 L 580 340" class="message-arrow"/>
    <text x="335" y="335" class="message-text" text-anchor="middle">権限付与</text>
    
    <!-- 9. Authorization Code -->
    <path d="M 580 370 L 240 370" class="return-arrow"/>
    <text x="410" y="365" class="message-text" text-anchor="middle">認可コード</text>
    
    <!-- 10. Code to Client -->
    <path d="M 240 400 L 400 400" class="message-arrow"/>
    <text x="320" y="395" class="message-text" text-anchor="middle">コード転送</text>
    
    <!-- 11. Exchange Code for Token -->
    <path d="M 400 430 L 580 430" class="message-arrow"/>
    <text x="490" y="425" class="message-text" text-anchor="middle">コード⇔トークン交換</text>
    
    <!-- Note: Backend Channel -->
    <rect x="380" y="445" width="220" height="25" class="note-box" rx="3"/>
    <text x="490" y="461" class="note-text" text-anchor="middle">バックエンドチャネル（セキュア）</text>
    
    <!-- 12. Access & Refresh Token -->
    <path d="M 580 490 L 400 490" class="return-arrow"/>
    <text x="490" y="485" class="message-text" text-anchor="middle">アクセス＆リフレッシュトークン</text>
    
    <!-- 13. API Request with Token -->
    <path d="M 400 520 L 770 520" class="message-arrow"/>
    <text x="585" y="515" class="message-text" text-anchor="middle">API要求＋アクセストークン</text>
    
    <!-- 14. Validate Token (internal) -->
    <rect x="750" y="540" width="40" height="30" fill="#e6f3ff" stroke="#3498db" stroke-width="1" rx="2"/>
    <text x="770" y="558" class="note-text" text-anchor="middle">検証</text>
    
    <!-- 15. Protected Data -->
    <path d="M 770 590 L 400 590" class="return-arrow"/>
    <text x="585" y="585" class="message-text" text-anchor="middle">保護データ</text>
    
    <!-- 16. Display Data -->
    <path d="M 400 620 L 240 620" class="return-arrow"/>
    <text x="320" y="615" class="message-text" text-anchor="middle">データ表示</text>
    
    <!-- 17. View Protected Resource -->
    <path d="M 240 650 L 90 650" class="return-arrow"/>
    <text x="165" y="645" class="message-text" text-anchor="middle">保護リソース閲覧</text>
  </g>
</svg>